<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mini Snooker Readymag</title>
<style>
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI, Roboto, "Helvetica Neue", Arial}
.game-wrapper{width:100%;height:100%;position:relative;overflow:hidden;background:linear-gradient(180deg,#0b3a2f 0%, #07281f 100%)}
canvas{display:block;width:100%;height:100%;}
.ui{
position:absolute;left:12px;top:12px;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.06);backdrop-filter:blur(6px);color:#fff;font-size:13px
}
.hint{position:absolute;right:12px;top:12px;padding:8px 10px;border-radius:8px;background:rgba(0,0,0,0.35);color:#fff;font-size:13px}
.btn{background:rgba(255,255,255,0.08);padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;color:#fff}
.power-meter{height:6px;background:rgba(255,255,255,0.08);border-radius:6px;overflow:hidden;margin-top:6px}
.power-fill{height:100%;width:0%;background:linear-gradient(90deg,#ffd166,#ff6b6b)}
.no-select{user-select:none;-webkit-user-select:none;-ms-user-select:none}
</style>
</head>
<body>
<div class="game-wrapper no-select" id="game">
<canvas id="canvas"></canvas>
<div class="ui" id="ui">
<div>Em jogo: <span id="turn">1</span></div>
<div>Velas em movimento: <span id="moving">0</span></div>
<div style="margin-top:6px">Pontuação: <span id="score">0</span></div>
<div style="margin-top:6px">
<button id="resetBtn" class="btn">Repor</button>
<button id="rackBtn" class="btn" style="margin-left:6px">Repor bolas</button>
</div>
</div>
<div class="hint">Clica e arrasta no jogador branco para apontar e solta para bater. Força máxima = 120.</div>
</div>

<script>
(function(){
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const wrapper = document.getElementById('game');
const movingEl = document.getElementById('moving');
const scoreEl = document.getElementById('score');
const turnEl = document.getElementById('turn');
const resetBtn = document.getElementById('resetBtn');
const rackBtn = document.getElementById('rackBtn');
let DPR = window.devicePixelRatio || 1;

function fitCanvas(){
  const rect = wrapper.getBoundingClientRect();
  canvas.width = Math.max(300, Math.floor(rect.width * DPR));
  canvas.height = Math.max(200, Math.floor(rect.height * DPR));
  canvas.style.width = rect.width+'px';
  canvas.style.height = rect.height+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
fitCanvas();
window.addEventListener('resize', ()=>{ DPR = window.devicePixelRatio || 1; fitCanvas(); });

// Física
const TIME_STEP = 1/60;
const FRICTION = 0.992;
const RESTITUTION = 0.98;
const BALL_RADIUS = 10;
const POCKET_RADIUS = 26;

// Áudio simples
let audioCtx=null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function playCollisionSound(vol=0.1){
  try{
    ensureAudio();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.type='square'; o.frequency.value=180+Math.random()*200;
    g.gain.value=vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+0.04);
  }catch(e){}
}
function playPocketSound(){
  try{
    ensureAudio();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.type='sine'; o.frequency.value=120;
    g.gain.value=0.18;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.frequency.linearRampToValueAtTime(260,audioCtx.currentTime+0.08);
    o.stop(audioCtx.currentTime+0.12);
  }catch(e){}
}

// Bola
function Ball(x,y,color,mass=1){
  this.x=x; this.y=y; this.vx=0; this.vy=0; this.r=BALL_RADIUS;
  this.color=color; this.mass=mass; this.pocketed=false; this.shrink=1;
}
const balls=[];
let score=0; let turn=1;

function getPockets(){
  const W=canvas.clientWidth, H=canvas.clientHeight;
  return [{x:0,y:0},{x:W/2,y:0},{x:W,y:0},{x:0,y:H},{x:W/2,y:H},{x:W,y:H}];
}

function resetBalls(){
  balls.length=0;
  const W=canvas.clientWidth,H=canvas.clientHeight;
  balls.push(new Ball(W*0.25,H/2,'#ffffff',1.05)); // cue
  const startX=W*0.65, startY=H/2, spacing=BALL_RADIUS*2+2;
  let reds=0;
  for(let row=0; row<3; row++){
    for(let col=0; col<=row; col++){
      if(reds>=5) break;
      const x=startX + row*spacing;
      const y=startY + (col - row/2)*spacing;
      balls.push(new Ball(x,y,'#d7263d',1));
      reds++;
    }
    if(reds>=5) break;
  }
  balls.push(new Ball(startX+80,startY-50,'#ffd166',1));
  balls.push(new Ball(startX+80,startY+50,'#06d6a0',1));
  score=0; turn=1; updateUI();
}
resetBalls();

// Input mira
let isAiming=false, aimStart=null, aimPos=null;
const cueIndex=0;
function getPointer(e){
  const rect=canvas.getBoundingClientRect();
  const c=e.touches ? e.touches[0] : e;
  return {x:c.clientX - rect.left, y:c.clientY - rect.top};
}
function pointerDown(e){
  e.preventDefault();
  const p=getPointer(e);
  const cue=balls[cueIndex];
  if(!cue || cue.pocketed) return;
  const dx=p.x-cue.x, dy=p.y-cue.y;
  if(dx*dx + dy*dy <= (cue.r*2.2)*(cue.r*2.2)){
    isAiming=true; aimStart={x:p.x,y:p.y}; aimPos={x:p.x,y:p.y};
    try{ if(!audioCtx){ ensureAudio(); audioCtx.resume&&audioCtx.resume(); } }catch(e){}
  }
}
function pointerMove(e){ if(!isAiming) return; e.preventDefault(); aimPos=getPointer(e); }
function pointerUp(e){
  if(!isAiming) return; e.preventDefault(); isAiming=false;
  const p=getPointer(e);
  const dx=aimStart.x-p.x, dy=aimStart.y-p.y;
  const power=Math.min(Math.hypot(dx,dy),160);
  const force=0.12;
  const cue=balls[cueIndex];
  cue.vx=(dx/(power||1))*power*force; cue.vy=(dy/(power||1))*power*force;
  turn++; updateUI();
}
canvas.addEventListener('mousedown', pointerDown);
canvas.addEventListener('touchstart', pointerDown,{passive:false});
window.addEventListener('mousemove', pointerMove);
window.addEventListener('touchmove', pointerMove,{passive:false});
window.addEventListener('mouseup', pointerUp);
window.addEventListener('touchend', pointerUp);

// Física
function resolveCollision(a,b){
  if(a.pocketed || b.pocketed) return;
  const dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy);
  if(dist===0) return;
  if(dist<a.r+b.r){
    const nx=dx/dist, ny=dy/dist;
    const overlap=a.r+b.r-dist;
    a.x-=nx*overlap/2; a.y-=ny*overlap/2;
    b.x+=nx*overlap/2; b.y+=ny*overlap/2;
    const rvx=b.vx-a.vx, rvy=b.vy-a.vy;
    const velAlongNormal=rvx*nx + rvy*ny;
    if(velAlongNormal>0) return;
    const e=Math.min(RESTITUTION,0.999);
    const j=-(1+e)*velAlongNormal/(1/a.mass + 1/b.mass);
    const jx=j*nx, jy=j*ny;
    a.vx-=jx/a.mass; a.vy-=jy/a.mass;
    b.vx+=jx/b.mass; b.vy+=jy/b.mass;
    const impulseMag=Math.hypot(jx,jy);
    playCollisionSound(Math.min(0.08 + impulseMag*0.0015,0.18));
  }
}
function applyFriction(b){ b.vx*=FRICTION; b.vy*=FRICTION; if(Math.hypot(b.vx,b.vy)<0.01){b.vx=0;b.vy=0;} }
function checkPockets(b){
  if(b.pocketed) return;
  const pockets=getPockets();
  for(const p of pockets){
    if(Math.hypot(b.x-p.x,b.y-p.y)<POCKET_RADIUS){
      b.pocketed=true; playPocketSound();
      if(b.color!=='#ffffff') score++; updateUI();
      (function(ball){ const interval=setInterval(()=>{ball.shrink-=0.06;if(ball.shrink<=0.05) clearInterval(interval);},30); })(b);
      b.vx=0; b.vy=0; return;
    }
  }
}

// Update / draw
function update(){
  for(const b of balls){ 
    if(b.pocketed) continue;
    b.x+=b.vx*(TIME_STEP*60); b.y+=b.vy*(TIME_STEP*60);
    applyFriction(b);
    if(b.x-b.r<0){ b.x=b.r; b.vx=-b.vx*0.88; }
    if(b.x+b.r>canvas.clientWidth){ b.x=canvas.clientWidth-b.r; b.vx=-b.vx*0.88; }
    if(b.y-b.r<0){ b.y=b.r; b.vy=-b.vy*0.88; }
    if(b.y+b.r>canvas.clientHeight){ b.y=canvas.clientHeight-b.r; b.vy=-b.vy*0.88; }
  }
  for(let i=0;i<balls.length;i++){ for(let j=i+1;j<balls.length;j++) resolveCollision(balls[i],balls[j]); }
  for(const b of balls) checkPockets(b);
  movingEl.textContent = balls.reduce((acc,b)=> acc+((Math.hypot(b.vx,b.vy)>0.5&&!b.pocketed)?1:0),0);
}

function drawTable(){
  const W=canvas.clientWidth,H=canvas.clientHeight;
  ctx.fillStyle='#0c6b52'; ctx.fillRect(0,0,W,H);
  const rail=Math.max(18,Math.min(32,Math.floor(W*0.03)));
  ctx.fillStyle='#2d1f14';
  ctx.fillRect(0,0,W,rail); ctx.fillRect(0,H-rail,W,rail);
  ctx.fillRect(0,0,rail,H); ctx.fillRect(W-rail,0,rail,H);
  const pockets=getPockets();
  ctx.fillStyle='rgba(0,0,0,0.6)';
  for(const p of pockets){ ctx.beginPath(); ctx.arc(p.x,p.y,POCKET_RADIUS,0,Math.PI*2); ctx.fill(); }
}

function drawBalls(){
  for(const b of balls){
    if(b.pocketed&&b.shrink<=0.05) continue;
    ctx.save(); ctx.translate(b.x,b.y); ctx.scale(b.shrink||1,b.shrink||1);
    ctx.beginPath(); ctx.ellipse(0,b.r*0.6,b.r*0.9,b.r*0.4,0,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fill();
    ctx.beginPath(); ctx.arc(0,0,b.r,0,Math.PI*2); ctx.fillStyle=b.color; ctx.fill();
    ctx.lineWidth=1.2; ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.stroke();
    if(b.color==='white'){ ctx.beginPath(); ctx.arc(0,0,b.r*0.45,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fill(); }
    ctx.restore();
  }
}

function drawAiming(){
  if(!isAiming) return;
  const cue=balls[cueIndex];
  const dx=aimPos.x-cue.x, dy=aimPos.y-cue.y;
  const angle=Math.atan2(dy,dx);
  ctx.beginPath(); ctx.moveTo(cue.x,cue.y); ctx.lineTo(aimPos.x,aimPos.y);
  ctx.setLineDash([6,6]); ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.stroke(); ctx.setLineDash([]);
  const power=Math.min(Math.hypot(aimStart.x-aimPos.x,aimStart.y-aimPos.y),160);
  ctx.beginPath(); ctx.arc(cue.x-Math.cos(angle)*20,cue.y-Math.sin(angle)*20,6+power/25,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fill();
}

function draw(){ ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight); drawTable(); drawBalls(); drawAiming(); }
function loop(){ update(); draw(); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

function updateUI(){ scoreEl.textContent=score; turnEl.textContent=turn; }
resetBtn.addEventListener('click',()=>{ for(const b of balls){b.vx=0;b.vy=0;b.pocketed=false;b.shrink=1;} score=0; turn=1; updateUI(); });
rackBtn.addEventListener('click',()=>{ resetBalls(); });

})();
</script>
